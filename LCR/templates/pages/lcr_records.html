{# pages/lcr_records.html #}
{% extends "base/base.html" %}
{% load tailwind_tags %}

{% block content %}
  <h1 class="text-base font-semibold mb-4">LCR Records & Ratios</h1>

  <form method="get" class="mb-6 flex items-center space-x-2 text-sm">
    <label class="font-medium">Select Date:</label>
    <select name="reporting_date" class="border rounded px-2 py-1 text-sm">
      <option value="">— pick a date —</option>
      {% for d in reporting_dates %}
        <option value="{{ d|date:'Y-m-d' }}" {% if selected_date == d %}selected{% endif %}>
          {{ d|date:"F j, Y" }}
        </option>
      {% endfor %}
    </select>
    <button type="submit"
            class="px-4 py-1 bg-[#171426] hover:bg-[#695404] text-white rounded text-sm">
      View Report
    </button>
  </form>

  {% if selected_date %}
    {# — LCR Summary Table — #}
    {% if lcr_data %}
      <section class="mb-8 text-sm">
        <h2 class="font-medium mb-2">LCR Summary</h2>
        <table class="w-full border-collapse border border-gray-300 text-sm">
          <thead>
            <tr class="bg-[#171426] text-white">
              <th class="px-2 py-1 text-left border border-gray-300">Currency</th>
              <th class="px-2 py-1 text-right border border-gray-300">HQLA</th>
              <th class="px-2 py-1 text-right border border-gray-300">Inflows</th>
              <th class="px-2 py-1 text-right border border-gray-300">Outflows</th>
              <th class="px-2 py-1 text-right border border-gray-300">Net Outflows</th>
              <th class="px-2 py-1 text-right border border-gray-300">LCR (%)</th>
            </tr>
          </thead>
          <tbody>
            {% for row in lcr_data %}
              {% if row.currency != 'Consolidated' %}
                <tr class="border-t">
                  <td class="px-2 py-1 border border-gray-300">{{ row.currency }}</td>
                  <td class="px-2 py-1 text-right border border-gray-300">{{ row.hqla }}</td>
                  <td class="px-2 py-1 text-right border border-gray-300">{{ row.inflow }}</td>
                  <td class="px-2 py-1 text-right border border-gray-300">{{ row.outflow }}</td>
                  <td class="px-2 py-1 text-right border border-gray-300">{{ row.net_out }}</td>
                  <td class="px-2 py-1 text-right border border-gray-300">
                    {% if row.lcr is not None %}{{ row.lcr }}{% else %}&mdash;{% endif %}
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
            {% for row in lcr_data %}
              {% if row.currency == 'Consolidated' %}
                <tr class="border-t font-medium bg-gray-50">
                  <td class="px-2 py-1 border border-gray-300">{{ row.currency }}</td>
                  <td class="px-2 py-1 text-right border border-gray-300">{{ row.hqla }}</td>
                  <td class="px-2 py-1 text-right border border-gray-300">{{ row.inflow }}</td>
                  <td class="px-2 py-1 text-right border border-gray-300">{{ row.outflow }}</td>
                  <td class="px-2 py-1 text-right border border-gray-300">{{ row.net_out }}</td>
                  <td class="px-2 py-1 text-right border border-gray-300">
                    {% if row.lcr is not None %}{{ row.lcr }}{% else %}&mdash;{% endif %}
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </section>
    {% else %}
      <p class="text-gray-700 mb-8 text-sm">
        No summary data for {{ selected_date|date:"F j, Y" }}.
      </p>
    {% endif %}

    {# — LCR Detailed Records — #}
    {% if currency_groups %}
      {% for group in currency_groups %}
        <section class="mb-8 text-sm">
          <h2 class="font-medium mb-2">{{ group.currency }} - Detailed Records</h2>
          <table class="w-full border-collapse border border-gray-300 text-sm">
            <thead>
              <tr class="bg-[#171426] text-white">
                <th class="px-2 py-1 text-left border border-gray-300">Type</th>
                <th class="px-2 py-1 text-left border border-gray-300">Section</th>
                <th class="px-2 py-1 text-left border border-gray-300">Item</th>
                <th class="px-2 py-1 text-left border border-gray-300">Weight</th>
                <th class="px-2 py-1 text-right border border-gray-300">Amount</th>
                <th class="px-2 py-1 text-right border border-gray-300">Adjusted Amount</th>
              </tr>
            </thead>
            <tbody>
              {% regroup group.rows by record_type as type_groups %}
              {% for type_group in type_groups %}
                {% regroup type_group.list by section_name as section_groups %}
                {% for section_group in section_groups %}
                  {% for row in section_group.list %}
                    <tr class="border-t">
                      {% if forloop.parentloop.first and forloop.first %}
                        <td rowspan="{{ type_group.list|length }}"
                            class="px-2 py-1 border border-gray-300 align-top">
                          {{ type_group.list.0.get_record_type_display }}
                        </td>
                      {% endif %}
                      {% if forloop.first %}
                        <td rowspan="{{ section_group.list|length }}"
                            class="px-2 py-1 border border-gray-300 align-top">
                          {{ section_group.list.0.section_name }}
                        </td>
                      {% endif %}
                      <td class="px-2 py-1 border border-gray-300">{{ row.item_name }}</td>
                      <td class="px-2 py-1 border border-gray-300">{{ row.section_weight }}</td>
                      <td class="px-2 py-1 text-right border border-gray-300">
                        {{ row.amount_before_weights }}
                      </td>
                      <td class="px-2 py-1 text-right border border-gray-300">
                        {{ row.adjusted_amount }}
                      </td>
                    </tr>
                  {% endfor %}
                {% endfor %}
              {% endfor %}

              {% for rec_type, subtotal in group.totals_by_type.items %}
                <tr class="bg-gray-50 font-medium">
                  <td colspan="5" class="px-2 py-1 text-right border border-gray-300">
                    Total {{ rec_type|title }}:
                  </td>
                  <td class="px-2 py-1 text-right border border-gray-300">
                    {{ subtotal }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </section>
      {% endfor %}
    {% endif %}

    {% if not lcr_data and not currency_groups %}
      <p class="text-center text-gray-600 text-sm">
        No LCR data found for {{ selected_date|date:"F j, Y" }}.
      </p>
    {% endif %}
  {% endif %}
{% endblock %}
