{% extends "base/base.html" %}
{% load tailwind_tags %}
{% block content %}
<div class="h-screen bg-gray-50 py-4 px-4 sm:px-6 lg:px-8 overflow-hidden">
  <div class="max-w-3xl mx-auto h-full flex flex-col text-gray-800">

    <!-- Header -->
    <div class="text-center mb-4">
      <div class="flex justify-center mb-2">
        <div class="p-2 bg-orange-100 rounded-full">
          <!-- Upload icon (outline style like base) -->
          <svg class="h-5 w-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M4 12l8-8m0 0l8 8M12 4v12"/>
          </svg>
        </div>
      </div>
      <h1 class="text-base font-semibold text-gray-900 mb-1">Cash Outflow Data Upload</h1>
      <p class="text-sm text-gray-600 max-w-xl mx-auto">
        Upload your Cash Outflow data files for LCR processing and analysis.
        Supports Excel (.xls, .xlsx) and CSV (.csv) formats.
      </p>
    </div>

    <!-- Card -->
    <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden flex-1 flex flex-col">
      <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
        <h2 class="text-sm font-semibold text-gray-900">File Upload</h2>
        <p class="text-xs text-gray-600 mt-1">Select your Cash Outflow data file to begin processing</p>
      </div>

      <div class="p-4 flex-1 flex flex-col">
        <form method="post" enctype="multipart/form-data" id="uploadForm" class="flex-1 flex flex-col space-y-3">
          {% csrf_token %}

          <!-- Drop Zone (click or drag) -->
          <button type="button"
                  id="dropZone"
                  class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-orange-400 hover:bg-orange-50 transition-colors duration-200 flex-1 focus:outline-none"
                  aria-label="Click to choose a file or drag and drop">
            <div class="h-full flex flex-col justify-center space-y-2 pointer-events-none">
              <div class="mx-auto text-gray-400">
                <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M4 12l8-8m0 0l8 8M12 4v12"/>
                </svg>
              </div>
              <div>
                <p class="text-xs text-gray-600">
                  <span class="font-medium text-orange-600">Click to upload</span> or drag and drop
                </p>
                <p class="text-xs text-gray-500 mt-1">
                  Excel (.xls, .xlsx) or CSV (.csv) files up to 50MB
                </p>
                <p class="text-xs text-gray-400">
                  Expected sheet name: "Cash Outflows"
                </p>
              </div>
            </div>
          </button>

          <!-- Hidden actual file input rendered by Django -->
          <div class="sr-only">{{ form.file }}</div>

          <!-- Dedicated picker button -->
          <div class="flex justify-center">
            <button type="button" id="filePickerBtn"
                    class="inline-flex items-center gap-2 px-3 py-1.5 text-xs rounded-md bg-[#171426] text-white hover:bg-[#695404]">
              <!-- Plus icon -->
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 4v16m8-8H4"/>
              </svg>
              Choose File
            </button>
          </div>

          <!-- File info (added dynamically) -->
          <div id="fileInfoAnchor"></div>

          <!-- Errors -->
          {% if form.errors %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-2">
              <div class="flex">
                <svg class="h-4 w-4 text-red-400 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01M12 5a7 7 0 100 14a7 7 0 000-14z"/>
                </svg>
                <div>
                  <h3 class="text-xs font-medium text-red-800">Please correct the following errors:</h3>
                  <ul class="mt-1 text-xs text-red-700 list-disc list-inside">
                    {% for field, errors in form.errors.items %}
                      {% for error in errors %}
                        <li>{{ error }}</li>
                      {% endfor %}
                    {% endfor %}
                  </ul>
                </div>
              </div>
            </div>
          {% endif %}

          <!-- Messages -->
          {% if messages %}
            {% for message in messages %}
              <div class="bg-green-50 border border-green-200 rounded-lg p-2 border-l-4 border-l-green-500">
                <div class="flex">
                  <svg class="h-4 w-4 text-green-600 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M5 13l4 4L19 7"/>
                  </svg>
                  <p class="text-xs font-medium text-green-700">{{ message }}</p>
                </div>
              </div>
            {% endfor %}
          {% endif %}

          <!-- Progress -->
          <div id="progressContainer" class="hidden">
            <div class="bg-gray-200 rounded-full h-1">
              <div id="progressBar" class="bg-orange-600 h-1 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-xs text-gray-600 mt-1">Uploading...</p>
          </div>

          <!-- Actions -->
          <div class="flex flex-col sm:flex-row gap-2 pt-2">
            <button type="submit" id="uploadBtn"
                    class="flex-1 bg-[#171426] text-white hover:bg-[#695404] py-2 px-4 flex items-center justify-center text-xs rounded-lg">
              <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M4 12l8-8m0 0l8 8M12 4v12"/>
              </svg>
              Upload &amp; Process
            </button>
            <button type="button" id="cancelBtn"
                    class="px-4 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-100 transition text-xs">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.querySelector('input[type="file"]');
  const form = document.getElementById('uploadForm');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const filePickerBtn = document.getElementById('filePickerBtn');
  const fileInfoAnchor = document.getElementById('fileInfoAnchor');
  const cancelBtn = document.getElementById('cancelBtn');

  // open picker
  filePickerBtn.addEventListener('click', () => fileInput && fileInput.click());
  dropZone.addEventListener('click', () => fileInput && fileInput.click());

  // drag & drop
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-orange-400','bg-orange-50');
  });
  dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-orange-400','bg-orange-50');
  });
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-orange-400','bg-orange-50');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      showFileInfo(files[0]);
    }
  });

  // file change
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) showFileInfo(e.target.files[0]);
  });

  function showFileInfo(file) {
    const mb = (file.size / 1024 / 1024).toFixed(2);
    const existing = fileInfoAnchor.querySelector('[data-file-info]');
    if (existing) existing.remove();

    const info = document.createElement('div');
    info.setAttribute('data-file-info', 'true');
    info.className = 'mt-2 p-2 bg-green-50 border border-green-200 rounded-lg';
    info.innerHTML = `
      <div class="flex items-center">
        <svg class="h-4 w-4 text-green-600 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span class="text-xs text-green-800"><strong>${file.name}</strong> (${mb} MB)</span>
      </div>`;
    fileInfoAnchor.appendChild(info);
  }

  // cancel resets state
  cancelBtn.addEventListener('click', () => {
    if (fileInput) fileInput.value = '';
    const existing = fileInfoAnchor.querySelector('[data-file-info]');
    if (existing) existing.remove();
    progressContainer.classList.add('hidden');
    progressBar.style.width = '0%';
    progressText.textContent = 'Uploading...';
  });

  // simulate progress (replace with XHR/fetch to show real progress if needed)
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    if (!fileInput || !fileInput.files.length) { alert('Please select a file to upload.'); return; }
    progressContainer.classList.remove('hidden');
    let progress = 0;
    const interval = setInterval(() => {
      progress += Math.random() * 15;
      if (progress >= 100) {
        progress = 100;
        clearInterval(interval);
        progressText.textContent = 'Processing Cash Outflow data...';
        setTimeout(() => form.submit(), 600);
      }
      progressBar.style.width = progress + '%';
      progressText.textContent = `Uploading... ${Math.round(progress)}%`;
    }, 200);
  });
});
</script>
{% endblock %}
