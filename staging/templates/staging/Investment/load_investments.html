{% extends 'base.html' %}
{% load static %}

{% block title %}Upload Investments{% endblock %}

{% block extra_css %}
<style>
    body {
        font-family: 'Montserrat', sans-serif;
        font-size: 14px;
    }
    
    .drop-zone {
        border: 2px dashed #dee2e6;
        transition: all 0.3s ease;
        font-family: 'Montserrat', sans-serif;
    }
    
    .drop-zone:hover, .drop-zone.dragover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }
    
    .step-circle {
        width: 40px;
        height: 40px;
        line-height: 40px;
        text-align: center;
        border-radius: 50%;
        display: inline-block;
        background-color: #f8f9fa;
        color: #6c757d;
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
    }
    
    .step-circle.active {
        background-color: #0d6efd;
        color: white;
    }
    
    .step-circle.completed {
        background-color: #198754;
        color: white;
    }
    
    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .btn {
        font-family: 'Montserrat', sans-serif;
        font-weight: 500;
        border-radius: 0.375rem;
    }
    
    .form-label {
        font-family: 'Montserrat', sans-serif;
        font-weight: 500;
        color: #495057;
    }
    
    .form-select, .form-control {
        font-family: 'Montserrat', sans-serif;
        border-radius: 0.375rem;
    }
    
    .alert {
        font-family: 'Montserrat', sans-serif;
        border-radius: 0.5rem;
    }
    
    .table {
        font-family: 'Montserrat', sans-serif;
        font-size: 13px;
    }
    
    .table th {
        font-weight: 600;
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
    
    .progress {
        border-radius: 0.5rem;
    }
    
    .toast {
        font-family: 'Montserrat', sans-serif;
    }
    
    .modal-content {
        border-radius: 0.75rem;
        border: none;
    }
    
    .badge {
        font-family: 'Montserrat', sans-serif;
        font-weight: 500;
    }
    
    h1, h2, h3, h4, h5, h6 {
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
    }
    
    .text-muted {
        color: #6c757d !important;
    }
    
    .required::after {
        content: ' *';
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-2">Upload Investments</h2>
                    <p class="text-muted mb-0">Import your investment data from Excel or CSV files.</p>
                </div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{% url 'alm_app:dashboard' %}" class="text-decoration-none">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="/staging/investment/" class="text-decoration-none">Investments</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Upload</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- Steps -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="position-relative">
                <div class="progress" style="height: 2px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: {% if step == 1 %}25%{% elif step == 2 %}50%{% elif step == 3 %}75%{% else %}100%{% endif %}"></div>
                </div>
                <div class="row text-center mt-3">
                    <div class="col-3">
                        <div class="step-circle {% if step >= 1 %}active{% endif %} {% if step > 1 %}completed{% endif %} mb-2">
                            {% if step > 1 %}<i class="fas fa-check"></i>{% else %}1{% endif %}
                        </div>
                        <div class="small {% if step >= 1 %}text-primary{% else %}text-muted{% endif %}">Upload</div>
                    </div>
                    <div class="col-3">
                        <div class="step-circle {% if step >= 2 %}active{% endif %} {% if step > 2 %}completed{% endif %} mb-2">
                            {% if step > 2 %}<i class="fas fa-check"></i>{% else %}2{% endif %}
                        </div>
                        <div class="small {% if step >= 2 %}text-primary{% else %}text-muted{% endif %}">Map</div>
                    </div>
                    <div class="col-3">
                        <div class="step-circle {% if step >= 3 %}active{% endif %} {% if step > 3 %}completed{% endif %} mb-2">
                            {% if step > 3 %}<i class="fas fa-check"></i>{% else %}3{% endif %}
                        </div>
                        <div class="small {% if step >= 3 %}text-primary{% else %}text-muted{% endif %}">Preview</div>
                    </div>
                    <div class="col-3">
                        <div class="step-circle {% if step >= 4 %}active{% endif %} mb-2">4</div>
                        <div class="small {% if step >= 4 %}text-primary{% else %}text-muted{% endif %}">Import</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="card shadow-sm">
        <!-- Upload Section -->
        <div id="upload-section" class="card-body {% if step != 1 %}d-none{% endif %}">
            <div id="drop-zone" class="drop-zone rounded p-5 text-center">
                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                <h5 class="mb-3">Drag and drop your file here</h5>
                <p class="text-muted mb-3">or</p>
                <input type="file" id="file-input" class="d-none" accept=".csv,.xlsx,.xls">
                <button class="btn px-4" onclick="document.getElementById('file-input').click()" style="background-color:#0B0920;color:#fff;border:1px solid #0B0920;" onmouseover="this.style.backgroundColor='#231E36'; this.style.borderColor='#231E36';" onmouseout="this.style.backgroundColor='#0B0920'; this.style.borderColor='#0B0920';">
                    <i class="fas fa-upload me-2"></i>Select File
                </button>
                <p class="text-muted small mt-3 mb-0">Supported formats: Excel, CSV (Max size: 500MB)</p>
            </div>

            <!-- File Details -->
            <div id="file-details" class="mt-4 d-none">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title mb-3"><i class="fas fa-file-alt me-2"></i>File Details</h6>
                        <p id="file-name" class="card-text mb-2"></p>
                        <p id="file-size" class="card-text mb-2"></p>
                        <p id="row-count" class="card-text mb-0"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mapping Section -->
        <div id="mapping-section" class="card-body {% if step != 2 %}d-none{% endif %}">
            <div class="mb-4">
                <h5 class="mb-3"><i class="fas fa-map me-2"></i>Column Mapping</h5>
                <p class="text-muted">Map your file columns to the required database fields.</p>
            </div>
            
            <form id="mapping-form" class="mb-4">
                <!-- Will be populated dynamically -->
            </form>

            <div class="alert alert-info">
                <h6 class="alert-heading mb-3">
                    <i class="fas fa-info-circle me-2"></i>Required Fields
                </h6>
                <ul class="list-unstyled mb-0" id="required-fields-list"></ul>
            </div>
        </div>

        <!-- Preview Section -->
        <div id="preview-section" class="card-body {% if step != 3 %}d-none{% endif %}">
            <div class="mb-4">
                <h5 class="mb-3"><i class="fas fa-eye me-2"></i>Data Preview</h5>
                <p class="text-muted">Review your data before importing.</p>
            </div>
            
            <div class="table-responsive">
                <table id="preview-table" class="table table-striped table-bordered">
                    <!-- Will be populated dynamically -->
                </table>
            </div>
        </div>

        <!-- Import Section -->
        <div id="import-section" class="card-body {% if step != 4 %}d-none{% endif %}">
            <div class="mb-4">
                <h5 class="mb-3"><i class="fas fa-download me-2"></i>Import Progress</h5>
            </div>
            
            <!-- Progress -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-medium">Overall Progress</span>
                    <span class="badge bg-primary" id="progress-percentage">0%</span>
                </div>
                <div class="progress" style="height: 10px;">
                    <div id="progress" class="progress-bar progress-bar-striped progress-bar-animated"></div>
                </div>
            </div>

            <!-- Stats -->
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card bg-light h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-list-ol text-primary mb-2" style="font-size: 1.5rem;"></i>
                            <h6 class="text-muted mb-3">Total Rows</h6>
                            <h2 id="total-rows" class="display-5 mb-0">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-check-circle text-success mb-2" style="font-size: 1.5rem;"></i>
                            <h6 class="text-muted mb-3">Successful</h6>
                            <h2 id="success-count" class="display-5 mb-0 text-success">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-exclamation-circle text-danger mb-2" style="font-size: 1.5rem;"></i>
                            <h6 class="text-muted mb-3">Failed</h6>
                            <h2 id="error-count" class="display-5 mb-0 text-danger">0</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error List -->
            <div id="error-list" class="alert alert-danger d-none">
                <!-- Will be populated with error messages -->
            </div>
        </div>

        <!-- Navigation -->
        <div class="card-footer bg-light d-flex justify-content-between py-3">
            <button id="prev-btn" class="btn btn-outline-secondary px-4 {% if step == 1 %}d-none{% endif %}">
                <i class="fas fa-arrow-left me-2"></i>Previous
            </button>
            <button id="next-btn" class="btn px-4" disabled style="background-color:#0B0920;color:#fff;border:1px solid #0B0920;" onmouseover="this.style.backgroundColor='#231E36'; this.style.borderColor='#231E36';" onmouseout="this.style.backgroundColor='#0B0920'; this.style.borderColor='#0B0920';">
                <span id="next-btn-text">Next</span>
                <i class="fas fa-arrow-right ms-2"></i>
            </button>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="success-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="mb-4">
                    <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-4" 
                         style="width: 80px; height: 80px;">
                        <i class="fas fa-check fa-3x"></i>
                    </div>
                    <h4 class="mb-3">Import Complete</h4>
                    <p class="text-muted mb-4">All investments have been successfully imported.</p>
                </div>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                    <button type="button" class="btn px-4 py-2" onclick="viewContracts()" style="background-color:#0B0920;color:#fff;border:1px solid #0B0920;" onmouseover="this.style.backgroundColor='#231E36'; this.style.borderColor='#231E36';" onmouseout="this.style.backgroundColor='#0B0920'; this.style.borderColor='#0B0920';">
                        <i class="fas fa-eye me-2"></i>View Investments
                    </button>
                    <button type="button" class="btn btn-outline-secondary px-4 py-2" onclick="uploadAnother()">
                        <i class="fas fa-upload me-2"></i>Upload Another
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="alert-template" class="toast align-items-center border-0 d-none" role="alert" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body"></div>
            <button type="button" class="btn-close ms-auto me-2" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // CSRF Token setup
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // File upload handling
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    let uploadedFileId = null;
    // Dynamic fields cache
    let backendFields = [];
    let requiredFieldNames = [];

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('border-primary', 'bg-light');
    }

    function unhighlight(e) {
        dropZone.classList.remove('border-primary', 'bg-light');
    }

    dropZone.addEventListener('drop', handleDrop, false);
    fileInput.addEventListener('change', handleChange, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const file = dt.files[0];
        handleFile(file);
    }

    function handleChange(e) {
        const file = e.target.files[0];
        handleFile(file);
    }

    function handleFile(file) {
        // Validate file type and size
        const validTypes = [
            'application/vnd.ms-excel',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'text/csv'
        ];
        
        if (!validTypes.includes(file.type) && 
            !['.csv', '.xlsx', '.xls'].some(ext => file.name.toLowerCase().endsWith(ext))) {
            showAlert('Please upload an Excel or CSV file.', 'danger');
            return;
        }

        // Check file size (500MB limit)
        if (file.size > 500 * 1024 * 1024) {
            showAlert('File size exceeds 500MB limit.', 'danger');
            return;
        }

        // Show file details immediately
        const fileDetails = document.getElementById('file-details');
        fileDetails.classList.remove('d-none');
        document.getElementById('file-name').textContent = `File Name: ${file.name}`;
        document.getElementById('file-size').textContent = `Size: ${(file.size / 1024 / 1024).toFixed(2)} MB`;

        // Create FormData
        const formData = new FormData();
        formData.append('file', file);

        // Upload file
        fetch('{% url "staging:upload_investment" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                uploadedFileId = data.file_id;
                document.getElementById('row-count').textContent = `Rows: ${data.row_count}`;
                showAlert('File uploaded successfully!', 'success');
                enableNextButton();
            } else {
                showAlert(data.error || 'Error uploading file.', 'danger');
                disableNextButton();
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            showAlert('Error uploading file. Please try again.', 'danger');
            disableNextButton();
        });
    }

    // Alert handling using Bootstrap Toast
    function showAlert(message, type) {
        const template = document.getElementById('alert-template');
        const toast = template.cloneNode(true);
        toast.removeAttribute('id');
        toast.classList.remove('d-none');
        toast.classList.add(`bg-${type}`, 'text-white');
        
        toast.querySelector('.toast-body').textContent = message;
        document.querySelector('.toast-container').appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }

    // Navigation handling
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    const sections = ['upload-section', 'mapping-section', 'preview-section', 'import-section'];
    let currentStep = {{ step }};

    function enableNextButton() {
        nextBtn.disabled = false;
        nextBtn.classList.remove('opacity-50');
    }

    function disableNextButton() {
        nextBtn.disabled = true;
        nextBtn.classList.add('opacity-50');
    }

    nextBtn.addEventListener('click', () => {
        if (currentStep < 4 && !nextBtn.disabled) {
            if (currentStep === 1 && !uploadedFileId) {
                showAlert('Please upload a file first.', 'danger');
                return;
            }

            document.getElementById(sections[currentStep - 1]).classList.add('d-none');
            document.getElementById(sections[currentStep]).classList.remove('d-none');
            currentStep++;
            updateNavigation();
            
            if (currentStep === 2) {
                loadColumnMapping();
                disableNextButton();
            }
            else if (currentStep === 3) loadPreview();
            else if (currentStep === 4) startImport();
        }
    });

    prevBtn.addEventListener('click', () => {
        if (currentStep > 1) {
            document.getElementById(sections[currentStep - 1]).classList.add('d-none');
            document.getElementById(sections[currentStep - 2]).classList.remove('d-none');
            currentStep--;
            updateNavigation();
            
            if (currentStep === 1 && uploadedFileId) {
                enableNextButton();
            }
        }
    });

    function updateNavigation() {
        prevBtn.classList.toggle('d-none', currentStep === 1);
        const nextText = currentStep === 4 ? 'Import' : 'Next';
        nextBtn.querySelector('#next-btn-text').textContent = nextText;
    }

    // Column mapping handling
    function loadColumnMapping() {
        if (!uploadedFileId) {
            showAlert('No file uploaded.', 'danger');
            return;
        }

        fetch(`/staging/investment/columns/${uploadedFileId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const mappingForm = document.getElementById('mapping-form');
                    mappingForm.innerHTML = '';

                    backendFields = data.fields || [];
                    requiredFieldNames = backendFields.filter(f => f.required).map(f => f.value);

                    // Render required fields list dynamically
                    const reqList = document.getElementById('required-fields-list');
                    reqList.innerHTML = '';
                    requiredFieldNames.forEach(name => {
                        const fieldMeta = backendFields.find(f => f.value === name);
                        const li = document.createElement('li');
                        li.className = 'mb-2';
                        li.innerHTML = `<i class="fas fa-circle text-muted me-2"></i>${fieldMeta ? fieldMeta.label : name}`;
                        reqList.appendChild(li);
                    });

                    // Create field info tooltips
                    const fieldInfo = {};
                    backendFields.forEach(field => {
                        let constraints = [];
                        if (field.required) constraints.push('Required');
                        if (field.unique) constraints.push('Unique');
                        if (field.max_length) constraints.push(`Max length: ${field.max_length}`);
                        if (field.max_digits && field.decimal_places) {
                            constraints.push(`Max digits: ${field.max_digits}, Decimal places: ${field.decimal_places}`);
                        }
                        if (field.help_text) constraints.push(field.help_text);
                        fieldInfo[field.value] = constraints;
                    });

                    data.columns.forEach(column => {
                        const div = document.createElement('div');
                        div.className = 'mb-3';

                        // Check if there's an automatic mapping for this column
                        const autoMapped = data.automatic_mapping[column];
                        
                        const labelHtml = `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">${column}</label>
                                ${autoMapped ? '<span class="badge bg-success">Auto-mapped</span>' : ''}
                            </div>
                        `;

                        const selectHtml = `
                            <select class="form-select" name="mapping_${column}" onchange="validateMapping()">
                                <option value="">-- Select Field --</option>
                                ${backendFields.map(field => {
                                    const constraints = fieldInfo[field.value];
                                    const constraintText = constraints.length > 0 ? ` (${constraints.join(', ')})` : '';
                                    return `
                                        <option value="${field.value}" 
                                                ${autoMapped === field.value ? 'selected' : ''}
                                                ${field.required ? 'data-required="true"' : ''}>
                                            ${field.label}${constraintText}
                                        </option>
                                    `;
                                }).join('')}
                            </select>
                        `;

                        div.innerHTML = labelHtml + selectHtml;
                        mappingForm.appendChild(div);
                    });

                    // Update required fields indicators
                    validateMapping();

                    // Show summary of automatic mappings
                    const autoMappedCount = Object.keys(data.automatic_mapping).length;
                    if (autoMappedCount > 0) {
                        showAlert(`Automatically mapped ${autoMappedCount} columns based on matching names.`, 'success');
                    }
                } else {
                    showAlert(data.error, 'danger');
                }
            })
            .catch(error => {
                showAlert('Error loading columns. Please try again.', 'danger');
            });
    }

    // Validate mapping selections
    function validateMapping() {
        const requiredFields = requiredFieldNames;
        const mappingSelects = document.querySelectorAll('#mapping-form select');
        const selectedValues = Array.from(mappingSelects).map(select => select.value);
        
        // Check required fields
        const allRequiredMapped = requiredFields.every(field => 
            selectedValues.includes(field)
        );

        // Check for duplicate mappings
        const duplicates = selectedValues.filter(value => value !== '')
            .filter((value, index, self) => 
                self.indexOf(value) !== index
            );

        if (duplicates.length > 0) {
            showAlert('Warning: Some fields are mapped multiple times.', 'warning');
            disableNextButton();
            return;
        }

        if (allRequiredMapped) {
            enableNextButton();
        } else {
            disableNextButton();
        }

        // Update required field indicators
        document.querySelectorAll('#mapping-form select').forEach(select => {
            const option = select.options[select.selectedIndex];
            const isRequired = option.getAttribute('data-required') === 'true';
            const label = select.parentElement.querySelector('.form-label');
            
            if (isRequired) {
                label.classList.add('required');
                if (!select.value) {
                    select.classList.add('is-invalid');
                } else {
                    select.classList.remove('is-invalid');
                }
            }
        });
    }

    // Preview handling
    function loadPreview() {
        const mappingData = getMappingData();

        fetch('/staging/investment/preview/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                file_id: uploadedFileId,
                mapping: mappingData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const table = document.getElementById('preview-table');
                table.innerHTML = '';

                if (!data.preview || data.preview.length === 0) {
                    table.innerHTML = '<tbody><tr><td class="text-muted">No rows to preview</td></tr></tbody>';
                    return;
                }

                // Add headers
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr class="table-light">
                        ${Object.keys(data.preview[0]).map(key => 
                            `<th class="text-nowrap">${key}</th>`
                        ).join('')}
                    </tr>
                `;
                table.appendChild(thead);

                // Add data rows
                const tbody = document.createElement('tbody');
                data.preview.forEach(row => {
                    tbody.innerHTML += `
                        <tr>
                            ${Object.values(row).map(value => 
                                `<td>${value !== null ? value : ''}</td>`
                            ).join('')}
                        </tr>
                    `;
                });
                table.appendChild(tbody);
            } else {
                showAlert(data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error loading preview. Please try again.', 'danger');
        });
    }

    // Import handling
    function startImport() {
        const mappingData = getMappingData();

        // Start polling progress immediately
        startProgressPolling();

        fetch('/staging/investment/import/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                file_id: uploadedFileId,
                mapping: mappingData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                stopProgressPolling();
                showAlert(data.error, 'danger');
            }
            // Progress UI is updated via polling
        })
        .catch(error => {
            stopProgressPolling();
            showAlert('Error during import. Please try again.', 'danger');
        });
    }

    let progressInterval = null;
    function startProgressPolling() {
        if (!uploadedFileId) return;
        stopProgressPolling();
        // Immediate fetch
        fetch(`/staging/investment/import/?file_id=${uploadedFileId}`)
            .then(r => r.json())
            .then(d => { if (d.success) updateProgress(d); });
        progressInterval = setInterval(() => {
            fetch(`/staging/investment/import/?file_id=${uploadedFileId}`)
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        updateProgress(d);
                        if (d.progress >= 100) {
                            stopProgressPolling();
                        }
                    }
                })
                .catch(() => {});
        }, 800);
    }
    function stopProgressPolling() {
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
    }

    function updateProgress(data) {
        const progress = document.getElementById('progress');
        const percentage = document.getElementById('progress-percentage');
        progress.style.width = `${data.progress}%`;
        percentage.textContent = `${data.progress}%`;
        
        document.getElementById('total-rows').textContent = data.total;
        document.getElementById('success-count').textContent = data.success_count;
        document.getElementById('error-count').textContent = data.errors.length;

        // Show errors if any
        const errorList = document.getElementById('error-list');
        if (data.errors.length > 0) {
            errorList.classList.remove('d-none');
            errorList.innerHTML = `
                <h6 class="alert-heading mb-2">Import Errors</h6>
                <ul class="mb-0">
                    ${data.errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
            `;
        }

        if (data.progress === 100) {
            const modal = new bootstrap.Modal(document.getElementById('success-modal'));
            modal.show();
        }
    }

    function getMappingData() {
        const mappingData = {};
        document.querySelectorAll('#mapping-form select').forEach(select => {
            const key = select.name.replace('mapping_', '');
            mappingData[key] = select.value;
        });
        return mappingData;
    }

    function viewContracts() {
        window.location.href = '/staging/investment/';
    }

    function uploadAnother() {
        window.location.reload();
    }
</script>
{% endblock %}
